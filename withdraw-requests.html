<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title data-i18n="withdraw_requests">Withdraw Requests</title>
        <link rel="icon" href="logo.jpg" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
    <script src="https://unpkg.com/i18next@21.6.14/dist/umd/i18next.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
        body{background:#0c1018;color:#fff;display:flex;justify-content:center;align-items:center;min-height:100vh;overflow-x:hidden;}
        .container{display:flex;width:100%;max-width:1200px;height:95vh;background:#1e293b;border-radius:12px;box-shadow:0 0 20px rgba(0,255,255,.1);margin:10px 0;position:relative;}
        .sidebar{width:250px;background:#111827;padding:20px;}
        .sidebar nav ul{list-style:none;}
        .sidebar nav ul li{padding:15px 10px;border-radius:8px;margin-bottom:10px;cursor:pointer;}
        .sidebar nav ul li.active a,.sidebar nav ul li:hover a{background:#00ffff;padding:18px;border-radius:15px;color:#000;text-decoration:none;}
        .sidebar nav ul li a{display:flex;align-items:center;color:inherit;text-decoration:none;width:100%;}
        .sidebar nav ul li .icon{margin-right:10px;font-size:18px;}
        .main-content{flex-grow:1;padding:30px 40px;overflow-y:auto;}
        .hamburger{display:none;position:absolute;top:20px;left:20px;background:none;border:none;color:#00ffff;font-size:24px;cursor:pointer;z-index:1000;}
        .section{background:#0c1018;padding:20px;border-radius:12px;margin-bottom:30px;}
        .section h2{color:#00ffff;margin-bottom:15px;}
        table{width:100%;border-collapse:collapse;background:#111827;border-radius:8px;overflow:hidden;}
        th,td{padding:12px;text-align:left;border-bottom:1px solid #2d3748;}
        th{background:#1e293b;color:#00ffff;font-weight:600;}
        .btn{padding:5px 10px;border:none;border-radius:4px;cursor:pointer;margin:0 3px;font-size:13px;}
        .approve{background:#00ff00;color:#000;}
        .reject{background:#ff4444;color:#fff;}
        .loading{text-align:center;color:#00ffff;padding:20px;}
        .kyc-badge{background:#ffcc00;color:#000;padding:4px 8px;border-radius:4px;font-size:12px;}
        @media (max-width:768px){.container{flex-direction:column;height:auto;}.sidebar{position:fixed;transform:translateX(-100%);}.sidebar.show{transform:translateX(0);}.hamburger{display:block;}}
    </style>
</head>
<body>

<div class="container" id="container" style="display:none;">
    <button class="hamburger"><i class="fa-solid fa-bars"></i></button>
    <div class="sidebar" id="sidebar">
        <nav>
            <ul>
                <li><a href="admin.html"><i class="fa-solid fa-user-shield icon"></i><span data-i18n="admin_dashboard">Admin Dashboard</span></a></li>
                <li><a href="deposit-requests.html"><i class="fa-solid fa-download icon"></i><span data-i18n="deposit_requests">Deposit Requests</span></a></li>
                <li class="active"><a href="withdraw-requests.html"><i class="fa-solid fa-upload icon"></i><span data-i18n="withdraw_requests">Withdraw Requests</span></a></li>
                <li><a href="#" id="logout-link"><i class="fa-solid fa-right-from-bracket icon"></i><span data-i18n="logout">Logout</span></a></li>
            </ul>
        </nav>
    </div>

    <main class="main-content">
        <h1 data-i18n="withdraw_requests">Withdraw Requests & Verification</h1>

        <!-- KYC Verification Section -->
        <section class="section">
            <h2><i class="fa-solid fa-id-card"></i> Verification Requests</h2>
            <div id="kyc-loading" class="loading">Loading verification requests...</div>
            <table id="kyc-table" style="display:none;">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Email</th>
                        <th>Requested At</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>

        <!-- Withdraw Requests Section -->
        <section class="section">
            <h2><i class="fa-solid fa-upload"></i> Withdraw Requests</h2>
            <div id="loading" class="loading">Loading withdraw requests...</div>
            <table id="withdraw-table" style="display:none;">
                <thead>
                    <tr>
                        <th data-i18n="user_name">Name</th>
                        <th data-i18n="amount">Amount</th>
                        <th data-i18n="method">Method</th>
                        <th data-i18n="status">Status</th>
                        <th data-i18n="actions">Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>
    </main>
</div>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getFirestore, collection, query, where, onSnapshot, doc, updateDoc, getDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

     const firebaseConfig = {
      apiKey: "AIzaSyCDfyVAhNfuXYyzeetQ1_wlFhz7-wXWHDk",
      authDomain: "treasure-f5cc7.firebaseapp.com",
      projectId: "treasure-f5cc7",
      storageBucket: "treasure-f5cc7.firebasestorage.app",
      messagingSenderId: "726318121382",
      appId: "1:726318121382:web:3cf5c5c7e628c9e313cf67",
      measurementId: "G-E3MBP4PH90"
    };
    const auth = getAuth(app);
    const db = getFirestore(app);

    // i18n
    i18next.init({
        lng: 'en',
        resources: { en: { translation: {
            withdraw_requests: "Withdraw Requests",
            user_name: "Name", amount: "Amount", method: "Method", status: "Status", actions: "Actions",
            no_data: "No pending requests", approve_confirm: "Approve withdrawal?", reject_confirm: "Reject withdrawal?",
            approve_kyc_confirm: "Approve this user's Request?", reject_kyc_confirm: "Reject this user's Request?"
        }}}
    }, () => document.querySelectorAll('[data-i18n]').forEach(el => el.textContent = i18next.t(el.dataset.i18n)));

    // Auth
    onAuthStateChanged(auth, user => {
        if (!user) return location.href = 'admin_login.html';
        document.getElementById('container').style.display = 'flex';
        loadKYCRequests();
        loadWithdrawals();
    });

    // Load KYC Requests
    function loadKYCRequests() {
        const tbody = document.querySelector('#kyc-table tbody');
        const loading = document.getElementById('kyc-loading');
        const table = document.getElementById('kyc-table');

        const q = query(collection(db, 'users'), where('verificationStatus', '==', 'pending'));

        onSnapshot(q, async snap => {
            tbody.innerHTML = '';
            if (snap.empty) {
                tbody.innerHTML = `<tr><td colspan="5">No pending KYC requests</td></tr>`;
                loading.style.display = 'none';
                table.style.display = 'table';
                return;
            }

            for (const docSnap of snap.docs) {
                const userData = docSnap.data();
                const uid = docSnap.id;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${userData.name || 'N/A'}</strong></td>
                    <td>${userData.email || 'N/A'}</td>
                    <td>${userData.verificationRequestedAt ? new Date(userData.verificationRequestedAt.toDate()).toLocaleString() : 'N/A'}</td>
                    <td><span class="kyc-badge">Pending Verification</span></td>
                    <td>
                        <button class="btn approve" data-uid="${uid}">Approve KYC</button>
                        <button class="btn reject" data-uid="${uid}">Reject KYC</button>
                    </td>`;
                tbody.appendChild(tr);
            }

            loading.style.display = 'none';
            table.style.display = 'table';

            // Approve KYC
            document.querySelectorAll('#kyc-table .approve').forEach(btn => {
                btn.onclick = async () => {
                    if (!confirm(i18next.t('approve_kyc_confirm'))) return;
                    await updateDoc(doc(db, 'users', btn.dataset.uid), {
                        verificationStatus: 'approved',
                        verifiedAt: serverTimestamp()
                    });
                    alert('Request Approved!');
                };
            });

            // Reject KYC
            document.querySelectorAll('#kyc-table .reject').forEach(btn => {
                btn.onclick = async () => {
                    if (!confirm(i18next.t('reject_kyc_confirm'))) return;
                    await updateDoc(doc(db, 'users', btn.dataset.uid), {
                        verificationStatus: 'rejected',
                        rejectedAt: serverTimestamp()
                    });
                    alert('KYC Rejected');
                };
            });
        });
    }

    // Load Withdrawals (unchanged)
    async function loadWithdrawals() {
        const tbody = document.querySelector('#withdraw-table tbody');
        const loading = document.getElementById('loading');
        const table = document.getElementById('withdraw-table');

        onSnapshot(collection(db, 'withdrawRequests'), async snap => {
            tbody.innerHTML = '';
            loading.style.display = 'block';
            table.style.display = 'none';

            if (snap.empty) {
                tbody.innerHTML = `<tr><td colspan="5">${i18next.t('no_data')}</td></tr>`;
                loading.style.display = 'none';
                table.style.display = 'table';
                return;
            }

            const pendingRequests = snap.docs.filter(d => d.data().status === 'pending');

            if (pendingRequests.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5">${i18next.t('no_data')}</td></tr>`;
                loading.style.display = 'none';
                table.style.display = 'table';
                return;
            }

            for (const d of pendingRequests) {
                const r = d.data();
                const uid = r.uid;

                let userName = 'Unknown User';
                if (uid) {
                    const userSnap = await getDoc(doc(db, 'users', uid));
                    if (userSnap.exists()) {
                        const userData = userSnap.data();
                        userName = userData.name || userData.email?.split('@')[0] || 'User';
                    }
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${userName}</strong></td>
                    <td>$${parseFloat(r.amount).toFixed(2)}</td>
                    <td>${r.method}</td>
                    <td><span style="color:#ffcc00;">Pending</span></td>
                    <td>
                        <button class="btn approve" data-id="${d.id}" data-uid="${uid}" data-amt="${r.amount}">Approve</button>
                        <button class="btn reject" data-id="${d.id}">Reject</button>
                    </td>`;
                tbody.appendChild(tr);
            }

            loading.style.display = 'none';
            table.style.display = 'table';

            // Approve withdrawal
            document.querySelectorAll('#withdraw-table .approve').forEach(btn => {
                btn.onclick = async () => {
                    if (!confirm(i18next.t('approve_confirm'))) return;

                    const reqId = btn.dataset.id;
                    const uid = btn.dataset.uid;
                    const amount = parseFloat(btn.dataset.amt);

                    try {
                        const userRef = doc(db, 'users', uid);
                        const userSnap = await getDoc(userRef);
                        if (!userSnap.exists()) throw new Error('User not found');

                        const user = userSnap.data();
                        const newWithdrawals = (user.withdrawals || 0) + amount;
                        const newBalance = (user.balance || 0) - amount;

                        await updateDoc(userRef, {
                            withdrawals: newWithdrawals,
                            balance: newBalance
                        });

                        await updateDoc(doc(db, 'withdrawRequests', reqId), {
                            status: 'approved',
                            approvedAt: serverTimestamp(),
                            approvedBy: auth.currentUser.uid
                        });

                        alert('Withdrawal approved!');
                    } catch (err) {
                        console.error(err);
                        alert('Error: ' + err.message);
                    }
                };
            });

            // Reject withdrawal
            document.querySelectorAll('#withdraw-table .reject').forEach(btn => {
                btn.onclick = async () => {
                    if (!confirm(i18next.t('reject_confirm'))) return;
                    await updateDoc(doc(db, 'withdrawRequests', btn.dataset.id), {
                        status: 'rejected',
                        rejectedAt: serverTimestamp()
                    });
                    alert('Withdrawal rejected');
                };
            });
        });
    }

    // Logout
    document.getElementById('logout-link').onclick = e => {
        e.preventDefault();
        signOut(auth).then(() => location.href = 'admin_login.html');
    };

    // Hamburger
    document.querySelector('.hamburger').onclick = () => {
        document.getElementById('sidebar').classList.toggle('show');
    };
</script>
<div data-key="Translator Dropdown" class="ft" id="ftgug97c7g"></div>
<script src="https://wdg.fouita.com/widgets/0x36a32f.js"></script>
<!-- Persistent Language Script -->
<script src="language.js"></script>
</body>
</html>