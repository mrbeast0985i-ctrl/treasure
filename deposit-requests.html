<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title data-i18n="deposit_requests">Deposit Requests</title>
        <link rel="icon" href="logo.jpg" type="image/x-icon">   
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
    <script src="https://unpkg.com/i18next@21.6.14/dist/umd/i18next.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
        body{background:#0c1018;color:#fff;display:flex;justify-content:center;align-items:center;min-height:100vh;overflow-x:hidden;}
        .container{display:flex;width:100%;max-width:1200px;height:95vh;background:#1e293b;border-radius:12px;box-shadow:0 0 20px rgba(0,255,255,.1);margin:10px 0;position:relative;}
        .sidebar{width:250px;background:#111827;padding:20px;}
        .sidebar nav ul{list-style:none;}
        .sidebar nav ul li{padding:15px 10px;border-radius:8px;margin-bottom:10px;cursor:pointer;}
        .sidebar nav ul li.active a,.sidebar nav ul li:hover a{background:#00ffff;padding:18px;border-radius:15px;color:#000;text-decoration:none;}
        .sidebar nav ul li a{display:flex;align-items:center;color:inherit;text-decoration:none;width:100%;}
        .sidebar nav ul li .icon{margin-right:10px;font-size:18px;}
        .main-content{flex-grow:1;padding:30px 40px;overflow-y:auto;}
        .hamburger{display:none;position:absolute;top:20px;left:20px;background:none;border:none;color:#00ffff;font-size:24px;cursor:pointer;z-index:1000;}
        .section{background:#0c1018;padding:20px;border-radius:12px;margin-bottom:30px;}
        .section h2{color:#00ffff;margin-bottom:15px;}
        table{width:100%;border-collapse:collapse;background:#111827;border-radius:8px;overflow:hidden;}
        th,td{padding:12px;text-align:left;border-bottom:1px solid #2d3748;}
        th{background:#1e293b;color:#00ffff;font-weight:600;}
        .btn{padding:5px 10px;border:none;border-radius:4px;cursor:pointer;margin:0 3px;font-size:13px;}
        .approve{background:#00ff00;color:#000;}
        .reject{background:#ff4444;color:#fff;}
        .view-proof{color:#00ffff;text-decoration:underline;cursor:pointer;font-size:12px;}
        .view-proof:hover{opacity:0.8;}

        /* MODAL */
        #proof-modal{display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,.85);z-index:3000;justify-content:center;align-items:center;padding:20px;}
        #proof-modal.show{display:flex;}
        .modal-content{background:#1e293b;border-radius:16px;max-width:90%;max-height:90%;overflow:hidden;position:relative;box-shadow:0 0 30px rgba(0,255,255,.2);}
        .modal-header{padding:16px 20px;background:#111827;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #2d3748;}
        .modal-title{color:#00ffff;font-size:18px;font-weight:600;}
        .close-modal{background:none;border:none;color:#00ffff;font-size:24px;cursor:pointer;}
        .modal-body{padding:20px;display:flex;justify-content:center;align-items:center;min-height:400px;background:#0c1018;}
        .proof-image{max-width:100%;max-height:70vh;border-radius:8px;}
        .proof-pdf{width:100%;height:70vh;border:none;border-radius:8px;}
        .loading-spinner{border:4px solid #2d3748;border-top:4px solid #00ffff;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin: auto;}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

        @media (max-width:768px){
            .container{flex-direction:column;height:auto;}
            .sidebar{position:fixed;transform:translateX(-100%);z-index:999;}
            .sidebar.show{transform:translateX(0);}
            .hamburger{display:block;}
            .main-content{padding:20px;}
            table{font-size:14px;}
            .btn{font-size:12px;padding:4px 8px;}
            .modal-content{max-width:95%;}
        }
    </style>
</head>
<body>

<div class="container" id="container" style="display:none;">
    <button class="hamburger"><i class="fa-solid fa-bars"></i></button>
    <div class="sidebar" id="sidebar">
        <nav>
            <ul>
                <li><a href="admin.html"><i class="fa-solid fa-user-shield icon"></i><span data-i18n="admin_dashboard">Admin Dashboard</span></a></li>
                <li class="active"><a href="deposit-requests.html"><i class="fa-solid fa-download icon"></i><span data-i18n="deposit_requests">Deposit Requests</span></a></li>
                <li><a href="withdraw-requests.html"><i class="fa-solid fa-upload icon"></i><span data-i18n="withdraw_requests">Withdraw Requests</span></a></li>
                <li><a href="#" id="logout-link"><i class="fa-solid fa-right-from-bracket icon"></i><span data-i18n="logout">Logout</span></a></li>
            </ul>
        </nav>
    </div>

    <main class="main-content">
        <h1 data-i18n="deposit_requests">Deposit Requests</h1>
        <section class="section">
            <table id="deposit-table">
                <thead>
                    <tr>
                        <th data-i18n="user_email">Email</th>
                        <th data-i18n="amount">Amount</th>
                        <th data-i18n="proof">Proof</th>
                        <th data-i18n="status">Status</th>
                        <th data-i18n="actions">Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>
    </main>
</div>

<!-- PROOF MODAL -->
<div id="proof-modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">Payment Proof</div>
            <button class="close-modal"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body" id="modal-body">
            <div class="loading-spinner"></div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getFirestore, collection, onSnapshot, doc, updateDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

    const app = initializeApp({
        apiKey: "AIzaSyDnEbph9IMZuJ3REbfTsocV-g7APCrE-1w",
        authDomain: "investment-40343.firebaseapp.com",
        projectId: "investment-40343",
        storageBucket: "investment-40343.firebasestorage.app",
        messagingSenderId: "126093031981",
        appId: "1:126093031981:web:fd4ae73c063044693b16a4"
    });
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ========== GLOBAL FUNCTIONS ==========
    window.openProof = function(url) {
        const modal = document.getElementById('proof-modal');
        const modalBody = document.getElementById('modal-body');
        
        modalBody.innerHTML = '<div class="loading-spinner"></div>';
        modal.classList.add('show');

        const isPDF = url.toLowerCase().endsWith('.pdf');
        
        if (isPDF) {
            modalBody.innerHTML = `<iframe src="${url}" class="proof-pdf"></iframe>`;
        } else {
            const img = new Image();
            img.onload = () => {
                modalBody.innerHTML = `<img src="${img.src}" class="proof-image" alt="Proof">`;
            };
            img.onerror = () => {
                modalBody.innerHTML = '<p style="color:#ff4444;text-align:center;">Failed to load image</p>';
            };
            img.src = url;
        }
    };

    window.closeProofModal = function() {
        document.getElementById('proof-modal').classList.remove('show');
    };

    // ========== i18n ==========
    i18next.init({
        lng: 'en',
        resources: { en: { translation: {
            deposit_requests: "Deposit Requests",
            user_email: "Email", amount: "Amount", status: "Status", actions: "Actions",
            proof: "Proof", view: "View", no_data: "No pending requests"
        }}}
    }, () => {
        document.querySelectorAll('[data-i18n]').forEach(el => {
            el.textContent = i18next.t(el.dataset.i18n);
        });
    });

    // ========== AUTH ==========
    onAuthStateChanged(auth, user => {
        if (!user) {
            location.href = 'admin_login.html';
            return;
        }
        document.getElementById('container').style.display = 'flex';
        loadDeposits();
    });

    // ========== MODAL EVENTS ==========
    const modal = document.getElementById('proof-modal');
    const closeModal = document.querySelector('.close-modal');

    closeModal.onclick = () => modal.classList.remove('show');
    modal.onclick = e => { if (e.target === modal) modal.classList.remove('show'); };

    // ========== LOAD DEPOSITS ==========
    function loadDeposits() {
        onSnapshot(collection(db, 'depositRequests'), snap => {
            const tbody = document.querySelector('#deposit-table tbody');
            tbody.innerHTML = '';
            
            const pending = snap.docs.filter(d => d.data().status === 'pending');
            if (pending.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">${i18next.t('no_data')}</td></tr>`;
                return;
            }

            pending.forEach(d => {
                const r = d.data();
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${r.userEmail || 'N/A'}</td>
                    <td>$${parseFloat(r.amount || 0).toFixed(2)}</td>
                    <td><span class="view-proof" onclick="openProof('${r.proofURL}')">View</span></td>
                    <td><span style="color:#ffcc00;">Pending</span></td>
                    <td>
                        <button class="btn approve" data-id="${d.id}" data-user="${r.userId}" data-amt="${r.amount}">Approve</button>
                        <button class="btn reject" data-id="${d.id}">Reject</button>
                    </td>`;
                tbody.appendChild(tr);
            });

            // Event listeners
            document.querySelectorAll('.approve').forEach(b => {
                b.onclick = async () => {
                    const userRef = doc(db, 'users', b.dataset.user);
                    const userSnap = await getDoc(userRef);
                    if (!userSnap.exists()) return alert('User not found');

                    const user = userSnap.data();
                    const amt = parseFloat(b.dataset.amt);
                    const newDep = (user.totalDeposit || 0) + amt;
                    const newBal = newDep + (user.totalProfit || 0) + (user.totalBonus || 0) - (user.withdrawals || 0);

                    await updateDoc(userRef, { totalDeposit: newDep, balance: newBal });
                    await updateDoc(doc(db, 'depositRequests', b.dataset.id), { status: 'approved' });
                };
            });

            document.querySelectorAll('.reject').forEach(b => {
                b.onclick = () => {
                    updateDoc(doc(db, 'depositRequests', b.dataset.id), { status: 'rejected' });
                };
            });
        });
    }

    // ========== LOGOUT ==========
    document.getElementById('logout-link').onclick = e => {
        e.preventDefault();
        signOut(auth).then(() => location.href = 'admin_login.html');
    };

    // ========== HAMBURGER ==========
    document.querySelector('.hamburger').onclick = () => {
        document.getElementById('sidebar').classList.toggle('show');
    };
</script>
<div data-key="Translator Dropdown" class="ft" id="ftgug97c7g"></div>
<script src="https://wdg.fouita.com/widgets/0x36a32f.js"></script>
<script src="language.js"></script>
</body>
</html>