<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title data-i18n="admin_ykc_title">Admin – YKC Verifications</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
  <script src="https://unpkg.com/i18next@21.6.14/dist/umd/i18next.min.js"></script>
  <link rel="icon" href="logo.jpg" type="image/x-icon">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
    body{background:#000;color:#fff;display:flex;justify-content:center;align-items:center;min-height:100vh;overflow-x:hidden;}
    .container{display:flex;width:100%;max-width:1300px;height:95vh;background:#1e293b;border-radius:12px;box-shadow:0 0 20px rgba(0,255,255,.1);margin:10px 0;position:relative;}
    .sidebar{width:250px;background:#111827;padding:20px;display:flex;flex-direction:column;transition:transform .3s;}
    .sidebar nav ul{list-style:none;}
    .sidebar nav ul li{padding:15px 10px;border-radius:8px;margin-bottom:10px;cursor:pointer;transition:background .3s;}
    .sidebar nav ul li.active a,.sidebar nav ul li:hover a{background:#00ffff;padding:18px;border-radius:15px;color:#000;text-decoration:none;}
    .sidebar nav ul li a{display:flex;align-items:center;color:inherit;text-decoration:none;width:100%;}
    .sidebar nav ul li .icon{margin-right:10px;font-size:18px;}
    .main-content{flex-grow:1;padding:30px 40px;overflow-y:auto;}
    .hamburger{display:none;position:absolute;top:20px;left:20px;background:none;border:none;color:#00ffff;font-size:24px;cursor:pointer;z-index:1000;}
    .page-title{font-size:28px;color:#00ffff;margin-bottom:20px;text-align:center;}
    table{width:100%;border-collapse:collapse;margin-top:20px;}
    th,td{border:1px solid #2d3748;padding:12px;text-align:left;vertical-align:top;}
    th{background:#111827;color:#00ffff;}
    .status-pending{color:#ffcc00;}
    .status-approved{color:#00ff00;}
    .status-rejected{color:#ff4d4d;}
    .btn{padding:6px 12px;margin:0 4px;border:none;border-radius:4px;cursor:pointer;font-size:13px;}
    .btn.approve{background:#00ff00;color:#000;}
    .btn.reject{background:#ff4d4d;color:#fff;}
    .btn.view{background:#00bfff;color:#fff;}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);justify-content:center;align-items:center;z-index:2000;backdrop-filter:blur(5px);}
    .modal.show{display:flex;}
    .modal-content{max-width:95%;max-height:95%;background:#1e293b;padding:20px;border-radius:12px;overflow:hidden;position:relative;box-shadow:0 0 30px rgba(0,255,255,.2);}
    .modal-header{padding:16px 20px;background:#111827;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #2d3748;}
    .modal-header h3{color:#00ffff;font-size:18px;font-weight:600;}
    .modal-close{background:none;border:none;color:#00ffff;font-size:24px;cursor:pointer;}
    .modal-body{padding:20px;display:flex;justify-content:center;align-items:center;min-height:500px;background:#0c1018;}
    .loader{border:4px solid #2d3748;border-top:4px solid #00ffff;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    @media (max-width:768px){
      .container{flex-direction:column;height:auto;}
      .sidebar{position:fixed;top:0;left:0;height:100%;transform:translateX(-100%);z-index:999;}
      .sidebar.show{transform:translateX(0);}
      .hamburger{display:block;}
      .main-content{padding:20px;}
      .modal-content{max-width:98%;max-height:98%;}
    }
  </style>
</head>
<body>

<div class="container" id="main-container" style="display:none;">
  <button class="hamburger"><i class="fa-solid fa-bars"></i></button>

  <div class="sidebar" id="sidebar">
    <nav>
      <ul>
       <li class="active"><a href="admin.html"><i class="fa-solid fa-user-shield icon"></i><span data-i18n="admin_dashboard">Admin Dashboard</span></a></li>
                <li><a  href="admin-ykc.html"><i class="fa-solid fa-id-card icon"></i><span data-i18n="admin_ykc">Admin KYC</span></a></li>
                <li><a href="deposit-requests.html"><i class="fa-solid fa-download icon"></i><span data-i18n="deposit_requests">Deposit Requests</span></a></li>
                <li><a href="withdraw-requests.html"><i class="fa-solid fa-upload icon"></i><span data-i18n="withdraw_requests">Withdraw Requests</span></a></li>
                <li><a href="accounts.html"><i class="fa-solid fa-university icon"></i><span data-i18n="edit_bank">Edit Bank</span></a></li>
                <li><a href="admin_appeal.html"><i class="fa-solid fa-university icon"></i><span data-i18n="appeal">Appeal</span></a></li>
                <li><a href="carform.html"><i class="fa-solid fa-university icon"></i><span data-i18n="car_form">Car Form</span></a></li>
        <li><a href="#" id="logout-link"><i class="fa-solid fa-right-from-bracket icon"></i><span data-i18n="logout">Logout</span></a></li>
      </ul>
    </nav>
    <div class="language-selector">
      <select id="languageSwitcher">
        <option value="en">English</option>
        <option value="fr">Français</option>
        <option value="es">Español</option>
      </select>
    </div>
  </div>

  <main class="main-content">
    <h1 class="page-title" data-i18n="admin_ykc_title">YKC Verification Management</h1>
    <table id="ykcTable">
      <thead>
        <tr>
          <th data-i18n="user_id">User ID</th>
          <th data-i18n="full_name">Full Name</th>
          <th data-i18n="dob">DOB</th>
          <th data-i18n="address">Address</th>
          <th data-i18n="id_type">ID Type</th>
          <th data-i18n="document">Document</th>
          <th data-i18n="status">Status</th>
          <th data-i18n="submitted_at">Submitted</th>
          <th data-i18n="actions">Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>
</div>

<!-- MODAL FOR IMAGE/PDF VIEW -->
<div class="modal" id="docModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 data-i18n="viewing_document">Viewing ID Document</h3>
      <button class="modal-close"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="modal-body" id="modal-body">
      <div class="loader"></div>
    </div>
  </div>
</div>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getFirestore, collection, onSnapshot, doc, updateDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

     const app = initializeApp({
        apiKey: "AIzaSyCDfyVAhNfuXYyzeetQ1_wlFhz7-wXWHDk",
            authDomain: "treasure-f5cc7.firebaseapp.com",
            projectId: "treasure-f5cc7",
            storageBucket: "treasure-f5cc7.firebasestorage.app",
            messagingSenderId: "726318121382",
            appId: "1:726318121382:web:3cf5c5c7e628c9e313cf67",
            measurementId: "G-E3MBP4PH90"
            });


    const auth = getAuth(app);
    const db = getFirestore(app);

    // i18n
    i18next.init({
        lng: 'en',
        resources: { 
            en: { translation: {
                admin_ykc_title: "Admin – YKC Verifications", admin_ykc: "Admin YKC",
                user_id: "User ID", full_name: "Full Name", dob: "DOB", address: "Address",
                id_type: "ID Type", document: "Document", status: "Status", submitted_at: "Submitted",
                actions: "Actions", view: "View", approve: "Approve", reject: "Reject",
                no_submissions: "No submissions yet.", viewing_document: "Viewing ID Document"
            }}
        }
    }, () => document.querySelectorAll('[data-i18n]').forEach(el => el.textContent = i18next.t(el.dataset.i18n)));

    // Auth
    onAuthStateChanged(auth, user => {
        if (!user) return location.href = 'admin_login.html';
        document.getElementById('main-container').style.display = 'flex';
        loadAllSubmissions();
    });

    // Load all submissions
    function loadAllSubmissions() {
        onSnapshot(collection(db, 'ykc_verifications'), snap => {
            const tbody = document.querySelector('#ykcTable tbody');
            tbody.innerHTML = snap.empty ? `<tr><td colspan="9" style="text-align:center;">${i18next.t('no_submissions')}</td></tr>` : '';

            snap.forEach(d => {
                const data = d.data();
                const tr = document.createElement('tr');
                const statusClass = `status-${data.status || 'pending'}`;
                const statusText = (data.status || 'pending').charAt(0).toUpperCase() + (data.status || 'pending').slice(1);
                const submitted = data.submittedAt?.toDate?.()?.toLocaleString() || '—';

                tr.innerHTML = `
                    <td title="${data.uid}">${data.uid.slice(0,8)}...</td>
                    <td>${data.fullName || ''}</td>
                    <td>${data.dob || ''}</td>
                    <td>${data.address || ''}</td>
                    <td>${data.idType || ''}</td>
                    <td>
                        ${data.documentURL ? 
                            `<button class="btn view" data-url="${data.documentURL}" title="${i18next.t('view')}">
                                <i class="fa-solid fa-eye"></i> View
                             </button>` 
                            : '—'}
                    </td>
                    <td class="${statusClass}"><i class="fa-solid ${data.status === 'approved' ? 'fa-check' : data.status === 'rejected' ? 'fa-xmark' : 'fa-clock'}"></i> ${statusText}</td>
                    <td>${submitted}</td>
                    <td>
                        ${data.status === 'pending' ? `
                            <button class="btn approve" data-id="${d.id}" title="${i18next.t('approve')}">
                                <i class="fa-solid fa-check"></i>
                            </button>
                            <button class="btn reject" data-id="${d.id}" title="${i18next.t('reject')}">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        ` : '—'}
                    </td>`;
                tbody.appendChild(tr);
            });

            // View Document
            document.querySelectorAll('.view').forEach(btn => {
                btn.onclick = () => openDocumentModal(btn.dataset.url);
            });

            // Approve/Reject
            document.querySelectorAll('.approve').forEach(b => b.onclick = () => changeStatus(b.dataset.id, 'approved'));
            document.querySelectorAll('.reject').forEach(b => b.onclick = () => changeStatus(b.dataset.id, 'rejected'));
        });
    }

    // Change status
    async function changeStatus(id, status) {
        if (!confirm(`Confirm ${status} this verification?`)) return;
        try {
            await updateDoc(doc(db, 'ykc_verifications', id), {
                status,
                reviewedAt: serverTimestamp(),
                reviewedBy: auth.currentUser.uid
            });
        } catch (err) {
            alert('Error: ' + err.message);
        }
    }

    // Open Document in Modal (Image or PDF)
    function openDocumentModal(url) {
        const modal = document.getElementById('docModal');
        const body = document.getElementById('modal-body');
        body.innerHTML = '<div class="loader"></div>';

        modal.classList.add('show');

        const isPDF = url.toLowerCase().endsWith('.pdf');

        if (isPDF) {
            const iframe = document.createElement('iframe');
            iframe.src = url;
            iframe.style.width = '100%';
            iframe.style.height = '100%';
            iframe.style.border = 'none';
            iframe.style.borderRadius = '8px';
            iframe.onload = () => body.innerHTML = '';
            iframe.onerror = () => body.innerHTML = '<p style="color:#ff4444;">Failed to load PDF</p>';
            setTimeout(() => body.appendChild(iframe), 500);
        } else {
            const img = new Image();
            img.onload = () => {
                body.innerHTML = `<img src="${url}" style="max-width:100%;max-height:80vh;border-radius:8px;" alt="ID Document">`;
            };
            img.onerror = () => {
                body.innerHTML = '<p style="color:#ff4444;">Failed to load image</p>';
            };
            img.src = url;
        }
    }

    // Close Modal
    document.querySelector('.modal-close').onclick = () => {
        document.getElementById('docModal').classList.remove('show');
        document.getElementById('modal-body').innerHTML = '<div class="loader"></div>';
    };

    // Close on background click
    document.getElementById('docModal').onclick = (e) => {
        if (e.target === document.getElementById('docModal')) {
            document.querySelector('.modal-close').click();
        }
    };

    // Logout
    document.getElementById('logout-link').onclick = e => {
        e.preventDefault();
        signOut(auth).then(() => location.href = 'admin_login.html');
    };
</script>
<div data-key="Translator Dropdown" class="ft" id="ftgug97c7g"></div>
<script src="https://wdg.fouita.com/widgets/0x36a32f.js"></script>

<!-- Persistent Language Script -->
<script src="language.js"></script>
</body>
</html>